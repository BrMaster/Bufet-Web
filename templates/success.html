<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Success - Buffet Menu</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    
    .side-left { position: fixed; left: 20px; top: 50%; transform: translateY(-50%); background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); z-index: 50; }
    .opening-time { font-size: 13px; font-weight: 600; color: #333; text-align: center; }
    .opening-time-label { font-size: 11px; color: #666; font-weight: 400; margin-bottom: 5px; }
    
    .side-right { position: fixed; right: 20px; top: 50%; transform: translateY(-50%); background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); z-index: 50; }
    .logo-placeholder { height: 80px; width: 80px; background: #e5e7eb; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 32px; gap: 5px; }
    .logo-text { font-size: 12px; font-weight: 700; color: #333; }
    
    .user-panel { background: #fff; padding: 12px 20px; border-radius: 10px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; gap: 20px; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-name { font-size: 14px; font-weight: 700; color: #333; }
    .session-timer { font-size: 14px; font-weight: 600; color: #16a34a; }
    .session-timer.warning { color: #f59e0b; }
    .session-timer.danger { color: #dc2626; }
    .panel-buttons { display: flex; gap: 8px; }
    .panel-button { display: inline-block; padding: 6px 16px; background: #0077cc; color: #fff; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 12px; transition: transform 0.1s ease; text-align: center; white-space: nowrap; }
    .panel-button:hover { transform: translateY(-1px); }
    .panel-button.logout { background: #dc2626; }
    
    .menu-section { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
    .menu-title { font-size: 24px; color: #333; margin-bottom: 20px; text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
    .payment-banner { margin-bottom: 14px; padding: 12px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; text-align: center; }
    .payment-banner.success { background: #d4edda; color: #155724; }
    .payment-banner.cancelled { background: #fff3cd; color: #856404; }
    .payment-banner.error { background: #f8d7da; color: #721c24; }
    .food-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .food-item { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
    .food-item:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: #667eea; }
    .food-image { width: 100%; aspect-ratio: 1; object-fit: cover; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #9ca3af; }
    .food-content { padding: 10px; }
    .food-name { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 4px; }
    .food-description { font-size: 11px; color: #666; margin-bottom: 8px; line-height: 1.3; }
    .food-details { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; }
    .food-price { font-size: 14px; font-weight: 700; color: #16a34a; }
    .food-stock { font-size: 10px; color: #666; background: #f3f4f6; padding: 2px 8px; border-radius: 12px; }
    .food-stock.low { background: #fee2e2; color: #dc2626; }
    .no-items { text-align: center; color: #999; padding: 40px; font-size: 16px; }
    .add-button { margin-top: 10px; width: 100%; padding: 8px 10px; border: none; border-radius: 6px; background: #667eea; color: #fff; font-weight: 600; cursor: pointer; transition: transform 0.1s ease; }
    .add-button:hover { transform: translateY(-1px); }
    .cart-bar { position: fixed; left: 0; right: 0; bottom: 0; background: #ffffff; box-shadow: 0 -8px 20px rgba(0,0,0,0.15); padding: 12px 20px; z-index: 100; transform: translateY(110%); opacity: 0; pointer-events: none; transition: transform 0.25s ease, opacity 0.25s ease; }
    .cart-bar.visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
    .cart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .cart-title { font-size: 14px; font-weight: 700; color: #333; }
    .cart-total { font-size: 14px; font-weight: 700; color: #16a34a; }
    .cart-items { display: grid; gap: 6px; max-height: 180px; overflow: auto; }
    .cart-item { display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 6px 8px; }
    .cart-item-name { font-size: 12px; font-weight: 600; color: #333; }
    .cart-item-qty { display: flex; align-items: center; gap: 6px; }
    .qty-btn { width: 26px; height: 26px; border-radius: 6px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; font-weight: 700; }
    .qty-value { min-width: 22px; text-align: center; font-size: 12px; font-weight: 600; }
    .order-button { margin-top: 10px; width: 100%; padding: 10px 12px; border-radius: 8px; border: none; background: #16a34a; color: #fff; font-weight: 700; cursor: pointer; }
    .order-button:disabled { background: #9ca3af; cursor: not-allowed; }
    .cart-message { font-size: 12px; color: #666; text-align: center; padding: 6px 0; }
    body { padding-bottom: 220px; }
    .paywall-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; z-index: 200; }
    .paywall-backdrop.visible { opacity: 1; pointer-events: auto; }
    .paywall-modal { width: 90%; max-width: 420px; background: #fff; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.2); padding: 20px; transform: translateY(10px); transition: transform 0.2s ease; }
    .paywall-backdrop.visible .paywall-modal { transform: translateY(0); }
    .paywall-title { font-size: 18px; font-weight: 700; margin-bottom: 6px; color: #111827; }
    .paywall-text { font-size: 13px; color: #4b5563; margin-bottom: 10px; }
    .paywall-total { font-weight: 700; color: #16a34a; margin-bottom: 14px; }
    .paywall-actions { display: flex; gap: 8px; }
    .paywall-btn { flex: 1; padding: 10px 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; }
    .paywall-btn.cancel { background: #e5e7eb; color: #111827; }
    .paywall-btn.pay { background: #2563eb; color: #fff; }
    .paywall-btn.person { background: #16a34a; color: #fff; }
  </style>
</head>
<body>
  <div class="side-left">
    <div class="opening-time">
      <div class="opening-time-label">Opening Hours</div>
      <div>Mon-Fri</div>
      <div>7:00-15:00</div>
    </div>
  </div>
  
  <div class="side-right">
    <div class="logo-placeholder">
      <div>üçΩÔ∏è</div>
      <div class="logo-text">BUFET</div>
    </div>
  </div>
  
  <div class="container">
    <div class="user-panel">
      <div class="user-info">
        <div class="user-name">{% if user_identifier %}{{ user_identifier }}{% else %}Guest{% endif %}</div>
        <div id="timer" class="session-timer">
          <span id="countdown">{{ remaining_minutes }}:{{ remaining_seconds|stringformat:"02d" }}</span>
        </div>
      </div>
      <div class="panel-buttons">
        <a class="panel-button" href="/">Home</a>
        <a class="panel-button logout" href="/logout/">Logout</a>
      </div>
    </div>
  
    <div class="menu-section">
      {% if request.GET.payment == 'success' %}
      <div class="payment-banner success">Payment confirmed. Order {% if request.GET.order_id %}#{{ request.GET.order_id }}{% endif %} is paid.</div>
      {% elif request.GET.payment == 'cancelled' %}
      <div class="payment-banner cancelled">Payment cancelled. You can try again.</div>
      {% elif request.GET.payment == 'error' %}
      <div class="payment-banner error">Payment confirmation failed. Please contact staff.</div>
      {% endif %}
      <h2 class="menu-title">üçΩÔ∏è Today's Menu</h2>
      {% if food_items %}
      <div class="food-grid">
        {% for item in food_items %}
        <div class="food-item">
          {% if item.image %}
          <img src="{{ item.image.url }}" alt="{{ item.name }}" class="food-image">
          {% else %}
          <div class="food-image">üçΩÔ∏è</div>
          {% endif %}
          <div class="food-content">
            <div class="food-name">{{ item.name }}</div>
            {% if item.description %}
            <div class="food-description">{{ item.description }}</div>
            {% endif %}
            <div class="food-details">
              <div class="food-price">‚Ç¨{{ item.price }}</div>
              <div class="food-stock {% if item.stock_count < 5 %}low{% endif %}">
                {{ item.stock_count }} available
              </div>
            </div>
            <button class="add-button" data-id="{{ item.id }}" data-name="{{ item.name|escapejs }}" data-price="{{ item.price }}">Add to cart</button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="no-items">No menu items available at this time.</div>
      {% endif %}
    </div>
  </div>

  <div class="cart-bar" id="cart-bar">
    <div class="cart-header">
      <div class="cart-title">üß∫ Your Cart</div>
      <div class="cart-total" id="cart-total">‚Ç¨0.00</div>
    </div>
    <div id="cart-items" class="cart-items"></div>
    <div id="cart-message" class="cart-message">Cart is empty. Add items to order.</div>
    <button id="order-button" class="order-button" disabled>Order</button>
  </div>

  <div id="paywall" class="paywall-backdrop" aria-hidden="true">
    <div class="paywall-modal" role="dialog" aria-modal="true" aria-labelledby="paywall-title">
      <div id="paywall-title" class="paywall-title">Complete payment</div>
      <div class="paywall-text">Choose how you want to pay before placing your order.</div>
      <div id="paywall-total" class="paywall-total">Total: ‚Ç¨0.00</div>
      <div class="paywall-actions">
        <button id="paywall-cancel" class="paywall-btn cancel" type="button">Cancel</button>
        <button id="paywall-person" class="paywall-btn person" type="button">Pay in Person</button>
        <button id="paywall-pay" class="paywall-btn pay" type="button">Pay with Card</button>
      </div>
    </div>
  </div>
  
  <script>
    let totalSeconds = {{ remaining_minutes }} * 60 + {{ remaining_seconds }};
    const timerEl = document.getElementById('timer');
    const countdownEl = document.getElementById('countdown');
    
    function updateTimer() {
      if (totalSeconds <= 0) {
        window.location.href = '/success/';
        return;
      }
      
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (totalSeconds <= 60) {
        timerEl.className = 'session-timer danger';
      } else if (totalSeconds <= 120) {
        timerEl.className = 'session-timer warning';
      } else {
        timerEl.className = 'session-timer';
      }
      
      totalSeconds--;
      setTimeout(updateTimer, 1000);
    }
    
    updateTimer();

    const cart = new Map();
    const cartItemsEl = document.getElementById('cart-items');
    const cartTotalEl = document.getElementById('cart-total');
    const orderButton = document.getElementById('order-button');
    const cartMessage = document.getElementById('cart-message');
    const cartBar = document.getElementById('cart-bar');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    function formatPrice(value) {
      return `‚Ç¨${Number(value).toFixed(2)}`;
    }

    function renderCart() {
      cartItemsEl.innerHTML = '';
      let total = 0;

      if (cart.size === 0) {
        cartMessage.style.display = 'block';
        orderButton.disabled = true;
        cartBar.classList.remove('visible');
      } else {
        cartMessage.style.display = 'none';
        orderButton.disabled = false;
        cartBar.classList.add('visible');
      }

      for (const [id, item] of cart.entries()) {
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.dataset.id = id;
        row.innerHTML = `
          <div class="cart-item-name">${item.name}</div>
          <div class="cart-item-qty">
            <button class="qty-btn" data-action="dec">-</button>
            <span class="qty-value">${item.quantity}</span>
            <button class="qty-btn" data-action="inc">+</button>
          </div>
          <div class="cart-item-price">${formatPrice(item.price * item.quantity)}</div>
        `;
        cartItemsEl.appendChild(row);
        total += item.price * item.quantity;
      }

      cartTotalEl.textContent = formatPrice(total);
    }

    function addToCart(id, name, price) {
      if (cart.has(id)) {
        cart.get(id).quantity += 1;
      } else {
        cart.set(id, { id, name, price, quantity: 1 });
      }
      renderCart();
    }

    document.querySelectorAll('.add-button').forEach(button => {
      button.addEventListener('click', () => {
        const id = parseInt(button.dataset.id, 10);
        const name = button.dataset.name;
        const price = parseFloat(button.dataset.price);
        addToCart(id, name, price);
      });
    });

    cartItemsEl.addEventListener('click', (event) => {
      const actionButton = event.target.closest('.qty-btn');
      if (!actionButton) return;
      const row = actionButton.closest('.cart-item');
      const id = parseInt(row.dataset.id, 10);
      const action = actionButton.dataset.action;
      if (!cart.has(id)) return;

      const item = cart.get(id);
      if (action === 'inc') {
        item.quantity += 1;
      } else if (action === 'dec') {
        item.quantity -= 1;
        if (item.quantity <= 0) {
          cart.delete(id);
        }
      }
      renderCart();
    });

    const paywall = document.getElementById('paywall');
    const paywallTotal = document.getElementById('paywall-total');
    const paywallCancel = document.getElementById('paywall-cancel');
    const paywallPerson = document.getElementById('paywall-person');
    const paywallPay = document.getElementById('paywall-pay');

    function getCartTotal() {
      let total = 0;
      for (const item of cart.values()) {
        total += item.price * item.quantity;
      }
      return total;
    }

    function openPaywall() {
      const total = getCartTotal();
      paywallTotal.textContent = `Total: ${formatPrice(total)}`;
      paywall.classList.add('visible');
      paywall.setAttribute('aria-hidden', 'false');
    }

    function closePaywall() {
      paywall.classList.remove('visible');
      paywall.setAttribute('aria-hidden', 'true');
    }

    paywallCancel.addEventListener('click', closePaywall);
    paywall.addEventListener('click', (event) => {
      if (event.target === paywall) {
        closePaywall();
      }
    });

    orderButton.addEventListener('click', () => {
      openPaywall();
    });

    paywallPerson.addEventListener('click', async () => {
      const items = Array.from(cart.values()).map(item => ({
        id: item.id,
        quantity: item.quantity
      }));

      orderButton.disabled = true;
      orderButton.textContent = 'Placing order...';

      try {
        const response = await fetch('/api/orders/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ items, payment_method: 'in_person' })
        });
        const result = await response.json();
        if (result.success) {
          cart.clear();
          renderCart();
          closePaywall();
          cartMessage.textContent = `Order #${result.order_id} placed. Total ‚Ç¨${result.total_amount}`;
          cartMessage.style.display = 'block';
        } else {
          cartMessage.textContent = result.message || 'Order failed.';
          cartMessage.style.display = 'block';
        }
      } catch (error) {
        cartMessage.textContent = 'Order failed. Please try again.';
        cartMessage.style.display = 'block';
      } finally {
        orderButton.textContent = 'Order';
        orderButton.disabled = cart.size === 0;
      }
    });

    paywallPay.addEventListener('click', async () => {
      const items = Array.from(cart.values()).map(item => ({
        id: item.id,
        quantity: item.quantity
      }));

      orderButton.disabled = true;
      orderButton.textContent = 'Redirecting...';

      try {
        const response = await fetch('/api/stripe-session/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ items })
        });
        const result = await response.json();
        if (result.success && result.checkout_url) {
          window.location.href = result.checkout_url;
        } else {
          cartMessage.textContent = result.message || 'Payment setup failed.';
          cartMessage.style.display = 'block';
          orderButton.textContent = 'Order';
          orderButton.disabled = cart.size === 0;
        }
      } catch (error) {
        cartMessage.textContent = 'Payment setup failed. Please try again.';
        cartMessage.style.display = 'block';
        orderButton.textContent = 'Order';
        orderButton.disabled = cart.size === 0;
      }
    });

    renderCart();
  </script>
</body>
</html>
