<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Logged In</title>
  <style>
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      height: 100vh;
      padding: 20px;
    }
    .container { 
      background: white; 
      padding: 30px; 
      border-radius: 15px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
      text-align: center; 
      max-width: 500px; 
      width: 100%;
    }
    h2 { 
      margin: 0 0 20px; 
      font-size: 28px; 
      color: #333;
    }
    .camera-wrapper {
      position: relative;
      width: 100%;
      max-width: 480px;
      margin: 0 auto 20px;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }
    video { 
      width: 100%; 
      display: block;
      background: #000; 
    }
    video.front-camera { 
      transform: scaleX(-1); 
    }
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .scanner-frame {
      width: 280px;
      height: 280px;
      border: 3px solid rgba(102, 126, 234, 0.8);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
      position: relative;
      background: rgba(0, 0, 0, 0.3);
    }
    .scanner-corner {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 3px solid #667eea;
    }
    .corner-top-left {
      top: -3px;
      left: -3px;
      border-right: none;
      border-bottom: none;
    }
    .corner-top-right {
      top: -3px;
      right: -3px;
      border-left: none;
      border-bottom: none;
    }
    .corner-bottom-left {
      bottom: -3px;
      left: -3px;
      border-right: none;
      border-top: none;
    }
    .corner-bottom-right {
      bottom: -3px;
      right: -3px;
      border-left: none;
      border-top: none;
    }
    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #667eea, transparent);
      top: 50%;
      animation: scan 2s infinite;
    }
    @keyframes scan {
      0% { top: 10%; }
      50% { top: 50%; }
      100% { top: 90%; }
    }
    .status { 
      margin-top: 15px; 
      color: #666; 
      font-size: 14px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .status.scanning {
      color: #667eea;
      font-weight: 600;
    }
    .status.success {
      color: #28a745;
      background: #d4edda;
    }
    .status.error {
      color: #dc3545;
      background: #f8d7da;
    }
    .result { 
      color: #0077cc; 
      font-weight: 600; 
      word-break: break-all;
      margin-top: 16px;
      padding: 16px;
      background: #f0f8ff;
      border-radius: 8px;
      display: none;
      border-left: 4px solid #0077cc;
    }
    .result.success {
      background: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }
    .result.error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }
    .alt-actions {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #999;
      font-size: 13px;
      margin: 10px 0;
    }
    .divider::before,
    .divider::after {
      content: "";
      height: 1px;
      background: #eee;
      flex: 1;
    }
    .upload-button {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid #d9e2ff;
      background: #f0f4ff;
      color: #2b4ea2;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }
    .upload-button:hover {
      box-shadow: 0 10px 20px rgba(40,72,160,0.12);
      transform: translateY(-1px);
    }
    .upload-button:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(40,72,160,0.1);
    }
    .material-symbols--qr-code-scanner-rounded {
      display: inline-block;
      width: 32px;
      height: 32px;
      --svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M3 7q-.425 0-.712-.288T2 6V3q0-.425.288-.712T3 2h3q.425 0 .713.288T7 3t-.288.713T6 4H4v2q0 .425-.288.713T3 7m0 15q-.425 0-.712-.288T2 21v-3q0-.425.288-.712T3 17t.713.288T4 18v2h2q.425 0 .713.288T7 21t-.288.713T6 22zm15 0q-.425 0-.712-.288T17 21t.288-.712T18 20h2v-2q0-.425.288-.712T21 17t.713.288T22 18v3q0 .425-.288.713T21 22zm3-15q-.425 0-.712-.288T20 6V4h-2q-.425 0-.712-.288T17 3t.288-.712T18 2h3q.425 0 .713.288T22 3v3q0 .425-.288.713T21 7m-3.5 12v-1.5H19V19zm0-3v-1.5H19V16zM16 17.5V16h1.5v1.5zM14.5 19v-1.5H16V19zM13 17.5V16h1.5v1.5zm3-3V13h1.5v1.5zM14.5 16v-1.5H16V16zM13 14.5V13h1.5v1.5zm1-3.5q-.425 0-.712-.288T13 10V6q0-.425.288-.712T14 5h4q.425 0 .713.288T19 6v4q0 .425-.288.713T18 11zm-8 8q-.425 0-.712-.288T5 18v-4q0-.425.288-.712T6 13h4q.425 0 .713.288T11 14v4q0 .425-.288.713T10 19zm0-8q-.425 0-.712-.288T5 10V6q0-.425.288-.712T6 5h4q.425 0 .713.288T11 6v4q0 .425-.288.713T10 11zm.5 6.5h3v-3h-3zm0-8h3v-3h-3zm8 0h3v-3h-3z'/%3E%3C/svg%3E");
      background-color: currentColor;
      -webkit-mask-image: var(--svg);
      mask-image: var(--svg);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: 100% 100%;
      mask-size: 100% 100%;
    }

    /* Success animation overlay */
    .success-overlay {
      position: absolute;
      inset: 0;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 150ms ease;
      z-index: 20;
    }
    .success-overlay.visible {
      opacity: 1;
      pointer-events: none;
    }
    .success-modal {
      width: 148px;
      aspect-ratio: 1 / 1;
      height: auto;
      background: transparent;
      border-radius: 20px;
      box-shadow: none;
      padding: 16px;
      text-align: center;
      position: relative;
      overflow: hidden;
      display: grid;
      place-items: center;
      transform: translateY(8px) scale(0.98);
      transition: transform 180ms ease;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
    }
    .success-overlay.visible .success-modal {
      transform: translateY(0) scale(1);
    }
  .success-title, .success-subtitle { display: none; }
    /* 1:1 success badge (ring + animated check) */
    .success-badge {
      width: 104px;
      aspect-ratio: 1 / 1;
      height: auto;
      border-radius: 999px;
      display: grid;
      place-items: center;
      margin: 0 auto;
      position: relative;
      transform: scale(0.9);
    }
    .success-badge svg,
    .success-badge circle,
    .success-badge path,
    .success-badge * {
      fill: none !important;
    }
    .success-overlay.visible .success-badge {
      animation: pop 520ms cubic-bezier(.2, .9, .2, 1) both;
    }
    .success-badge svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .badge-ring {
      fill: none;
  stroke: #00e5d4;
      stroke-width: 6;
      stroke-linecap: round;
      stroke-dasharray: 290;
      stroke-dashoffset: 290;
  filter: none;
    }
    .badge-check {
      fill: none;
  stroke: #00e5d4;
      stroke-width: 7;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 80;
      stroke-dashoffset: 80;
    }
    .success-overlay.visible .badge-ring {
  animation: ring 560ms ease-out forwards;
    }
    .success-overlay.visible .badge-check {
  animation: check 460ms 240ms ease-out forwards;
    }
    @keyframes ring {
      0% { stroke-dashoffset: 290; opacity: 0.9; }
      100% { stroke-dashoffset: 0; opacity: 1; }
    }
    @keyframes check {
      0% { stroke-dashoffset: 80; opacity: 0; }
      20% { opacity: 1; }
      100% { stroke-dashoffset: 0; opacity: 1; }
    }
    @keyframes pop {
      0% { transform: scale(0.65); }
      55% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
  /* Confetti removed: it can cause tinted/filled artifacts behind the badge on some browsers */

    @media (prefers-reduced-motion: reduce) {
      .scan-line { animation: none; }
      .success-modal, .success-overlay { transition: none; }
  .success-overlay.visible .success-badge { animation: none; transform: scale(1); }
  .badge-ring, .badge-check { animation: none !important; stroke-dashoffset: 0; opacity: 1; }
  /* confetti removed */
    }
  </style>
</head>
<body>
  <div class="container">
    <h2><span class="material-symbols--qr-code-scanner-rounded"></span> Scan QR Code</h2>
    <div class="camera-wrapper">
      <video id="camera" autoplay playsinline muted></video>
      <div class="scanner-overlay">
        <div class="scanner-frame">
          <div class="corner-top-left scanner-corner"></div>
          <div class="corner-top-right scanner-corner"></div>
          <div class="corner-bottom-left scanner-corner"></div>
          <div class="corner-bottom-right scanner-corner"></div>
          <div class="scan-line"></div>
        </div>
      </div>
      <div id="success-overlay" class="success-overlay" aria-hidden="true">
        <div class="success-modal" role="dialog" aria-modal="true" aria-label="Success">
          <div class="success-badge" aria-hidden="true">
            <svg viewBox="0 0 100 100" aria-hidden="true" focusable="false" fill="none">
              <circle class="badge-ring" cx="50" cy="50" r="42" fill="none"></circle>
              <path class="badge-check" d="M30 52 L44 66 L70 38" fill="none"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>
    <canvas id="canvas" style="display: none;"></canvas>
    <div id="status" class="status scanning">üîç Requesting camera access...</div>
    <div id="result" class="result"></div>
    <div id="upload" class="alt-actions">
      <div class="divider">or</div>
      <button id="upload-btn" type="button" class="upload-button">Upload QR photo</button>
      <input id="qr-upload" type="file" accept="image/*" style="display: none;" />
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    let scannedData = null;

    function showSuccessAnimation() {
      const overlay = document.getElementById('success-overlay');
      if (!overlay) return;
      overlay.classList.add('visible');
      overlay.setAttribute('aria-hidden', 'false');
    }

    function hideScannerOverlay() {
      const scannerOverlay = document.querySelector('.scanner-overlay');
      if (scannerOverlay) scannerOverlay.style.display = 'none';
      const videoEl = document.getElementById('camera');
      if (videoEl) videoEl.style.filter = 'brightness(0.82)';
    }
    
    async function saveQRToDatabase(data) {
      try {
        const response = await fetch('/api/scan-qr/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ data: data })
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('Error saving QR code:', error);
      }
    }

    async function startCamera() {
      const statusEl = document.getElementById('status');
      const videoEl = document.getElementById('camera');
      const canvasEl = document.getElementById('canvas');
      const resultEl = document.getElementById('result');
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusEl.textContent = '‚ùå Camera not supported in this browser.';
        statusEl.className = 'status error';
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' }, 
          audio: false 
        });
        videoEl.srcObject = stream;
        
        // Check if back camera is available, if not fallback to front camera
        const tracks = stream.getVideoTracks();
        const settings = tracks[0]?.getSettings?.();
        if (settings?.facingMode === 'user') {
          videoEl.classList.add('front-camera');
        }
        statusEl.innerHTML = 'üîç Camera is on - scanning for QR codes...';
        statusEl.className = 'status scanning';
        
        // Set up canvas for QR scanning
        const ctx = canvasEl.getContext('2d');
        canvasEl.width = videoEl.videoWidth || 640;
        canvasEl.height = videoEl.videoHeight || 480;
        
        // Start scanning
        function scanQR() {
          if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
            canvasEl.width = videoEl.videoWidth;
            canvasEl.height = videoEl.videoHeight;
            ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
            
            const imageData = ctx.getImageData(0, 0, canvasEl.width, canvasEl.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code && code.data !== scannedData) {
              scannedData = code.data;
              statusEl.innerHTML = '‚úì QR Code found! Verifying...';
              statusEl.className = 'status success';
              
              // Verify against database
              saveQRToDatabase(code.data).then(result => {
                if (result && result.valid) {
                  resultEl.innerHTML = `<strong>‚úì Access Granted!</strong><br>Welcome to the buffet`;
                  resultEl.className = 'result success';
                  statusEl.style.display = 'none';
                  resultEl.style.display = 'block';
                  hideScannerOverlay();
                  showSuccessAnimation();
                  // Redirect to success page after 1 second
                  setTimeout(() => {
                    window.location.href = result.redirect_url;
                  }, 1000);
                } else {
                  resultEl.innerHTML = `<strong>‚úó Invalid QR Code</strong><br>Code not recognized`;
                  resultEl.className = 'result error';
                  statusEl.innerHTML = '‚ùå QR code not recognized';
                  statusEl.className = 'status error';
                  resultEl.style.display = 'block';
                  scannedData = null; // Reset to scan again
                }
              });
            }
          }
          requestAnimationFrame(scanQR);
        }
        
        scanQR();
      } catch (err) {
        statusEl.innerHTML = '‚ùå Camera access denied or unavailable';
        statusEl.className = 'status error';
      }
    }

    function decodeImageFile(file) {
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      const canvasEl = document.getElementById('canvas');
      const ctx = canvasEl.getContext('2d');

      statusEl.textContent = 'üñºÔ∏è Reading image...';
      statusEl.className = 'status scanning';

      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
          canvasEl.width = img.width;
          canvasEl.height = img.height;
          ctx.drawImage(img, 0, 0, img.width, img.height);

          const imageData = ctx.getImageData(0, 0, img.width, img.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);

          if (code && code.data) {
            statusEl.textContent = '‚úì QR Code found! Verifying...';
            statusEl.className = 'status success';

            saveQRToDatabase(code.data).then(result => {
              if (result && result.valid) {
                resultEl.innerHTML = `<strong>‚úì Access Granted!</strong><br>Welcome to the buffet`;
                resultEl.className = 'result success';
                statusEl.style.display = 'none';
                resultEl.style.display = 'block';
                hideScannerOverlay();
                showSuccessAnimation();
                setTimeout(() => {
                  window.location.href = result.redirect_url;
                }, 1000);
              } else {
                resultEl.innerHTML = `<strong>‚úó Invalid QR Code</strong><br>Code not recognized`;
                resultEl.className = 'result error';
                statusEl.innerHTML = '‚ùå QR code not recognized';
                statusEl.className = 'status error';
                resultEl.style.display = 'block';
              }
            });
          } else {
            statusEl.textContent = '‚ùå No QR code found in the image.';
            statusEl.className = 'status error';
          }
        };
        img.onerror = function () {
          statusEl.textContent = '‚ùå Unable to read the image file.';
          statusEl.className = 'status error';
        };
        img.src = event.target.result;
      };
      reader.onerror = function () {
        statusEl.textContent = '‚ùå Failed to load the file.';
        statusEl.className = 'status error';
      };
      reader.readAsDataURL(file);
    }

    const uploadBtn = document.getElementById('upload-btn');
    const uploadInput = document.getElementById('qr-upload');
    uploadBtn.addEventListener('click', () => uploadInput.click());
    uploadInput.addEventListener('change', (event) => {
      const file = event.target.files && event.target.files[0];
      if (file) {
        decodeImageFile(file);
      }
    });

    startCamera();
  </script>
</body>
</html>
