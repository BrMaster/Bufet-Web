<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Logged In</title>
  <style>
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      height: 100vh;
      padding: 20px;
    }
    .container { 
      background: white; 
      padding: 30px; 
      border-radius: 15px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
      text-align: center; 
      max-width: 500px; 
      width: 100%;
    }
    h2 { 
      margin: 0 0 20px; 
      font-size: 28px; 
      color: #333;
    }
    .camera-wrapper {
      position: relative;
      width: 100%;
      max-width: 480px;
      margin: 0 auto 20px;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }
    video { 
      width: 100%; 
      display: block;
      background: #000; 
    }
    video.front-camera { 
      transform: scaleX(-1); 
    }
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .scanner-frame {
      width: 280px;
      height: 280px;
      border: 3px solid rgba(102, 126, 234, 0.8);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
      position: relative;
      background: rgba(0, 0, 0, 0.3);
    }
    .scanner-corner {
      position: absolute;
      width: 30px;
      height: 30px;
      border: 3px solid #667eea;
    }
    .corner-top-left {
      top: -3px;
      left: -3px;
      border-right: none;
      border-bottom: none;
    }
    .corner-top-right {
      top: -3px;
      right: -3px;
      border-left: none;
      border-bottom: none;
    }
    .corner-bottom-left {
      bottom: -3px;
      left: -3px;
      border-right: none;
      border-top: none;
    }
    .corner-bottom-right {
      bottom: -3px;
      right: -3px;
      border-left: none;
      border-top: none;
    }
    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #667eea, transparent);
      top: 50%;
      animation: scan 2s infinite;
    }
    @keyframes scan {
      0% { top: 10%; }
      50% { top: 50%; }
      100% { top: 90%; }
    }
    .status { 
      margin-top: 15px; 
      color: #666; 
      font-size: 14px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .status.scanning {
      color: #667eea;
      font-weight: 600;
    }
    .status.success {
      color: #28a745;
      background: #d4edda;
    }
    .status.error {
      color: #dc3545;
      background: #f8d7da;
    }
    .result { 
      color: #0077cc; 
      font-weight: 600; 
      word-break: break-all;
      margin-top: 16px;
      padding: 16px;
      background: #f0f8ff;
      border-radius: 8px;
      display: none;
      border-left: 4px solid #0077cc;
    }
    .result.success {
      background: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }
    .result.error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }
    .material-symbols--qr-code-scanner-rounded {
      display: inline-block;
      width: 32px;
      height: 32px;
      --svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M3 7q-.425 0-.712-.288T2 6V3q0-.425.288-.712T3 2h3q.425 0 .713.288T7 3t-.288.713T6 4H4v2q0 .425-.288.713T3 7m0 15q-.425 0-.712-.288T2 21v-3q0-.425.288-.712T3 17t.713.288T4 18v2h2q.425 0 .713.288T7 21t-.288.713T6 22zm15 0q-.425 0-.712-.288T17 21t.288-.712T18 20h2v-2q0-.425.288-.712T21 17t.713.288T22 18v3q0 .425-.288.713T21 22zm3-15q-.425 0-.712-.288T20 6V4h-2q-.425 0-.712-.288T17 3t.288-.712T18 2h3q.425 0 .713.288T22 3v3q0 .425-.288.713T21 7m-3.5 12v-1.5H19V19zm0-3v-1.5H19V16zM16 17.5V16h1.5v1.5zM14.5 19v-1.5H16V19zM13 17.5V16h1.5v1.5zm3-3V13h1.5v1.5zM14.5 16v-1.5H16V16zM13 14.5V13h1.5v1.5zm1-3.5q-.425 0-.712-.288T13 10V6q0-.425.288-.712T14 5h4q.425 0 .713.288T19 6v4q0 .425-.288.713T18 11zm-8 8q-.425 0-.712-.288T5 18v-4q0-.425.288-.712T6 13h4q.425 0 .713.288T11 14v4q0 .425-.288.713T10 19zm0-8q-.425 0-.712-.288T5 10V6q0-.425.288-.712T6 5h4q.425 0 .713.288T11 6v4q0 .425-.288.713T10 11zm.5 6.5h3v-3h-3zm0-8h3v-3h-3zm8 0h3v-3h-3z'/%3E%3C/svg%3E");
      background-color: currentColor;
      -webkit-mask-image: var(--svg);
      mask-image: var(--svg);
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      -webkit-mask-size: 100% 100%;
      mask-size: 100% 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2><span class="material-symbols--qr-code-scanner-rounded"></span> Scan QR Code</h2>
    <div class="camera-wrapper">
      <video id="camera" autoplay playsinline muted></video>
      <div class="scanner-overlay">
        <div class="scanner-frame">
          <div class="corner-top-left scanner-corner"></div>
          <div class="corner-top-right scanner-corner"></div>
          <div class="corner-bottom-left scanner-corner"></div>
          <div class="corner-bottom-right scanner-corner"></div>
          <div class="scan-line"></div>
        </div>
      </div>
    </div>
    <canvas id="canvas" style="display: none;"></canvas>
    <div id="status" class="status scanning">üîç Requesting camera access...</div>
    <div id="result" class="result"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    let scannedData = null;
    
    async function saveQRToDatabase(data) {
      try {
        const response = await fetch('/api/scan-qr/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ data: data })
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('Error saving QR code:', error);
      }
    }

    async function startCamera() {
      const statusEl = document.getElementById('status');
      const videoEl = document.getElementById('camera');
      const canvasEl = document.getElementById('canvas');
      const resultEl = document.getElementById('result');
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusEl.textContent = '‚ùå Camera not supported in this browser.';
        statusEl.className = 'status error';
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' }, 
          audio: false 
        });
        videoEl.srcObject = stream;
        
        // Check if back camera is available, if not fallback to front camera
        const tracks = stream.getVideoTracks();
        const settings = tracks[0]?.getSettings?.();
        if (settings?.facingMode === 'user') {
          videoEl.classList.add('front-camera');
        }
        statusEl.innerHTML = 'üîç Camera is on - scanning for QR codes...';
        statusEl.className = 'status scanning';
        
        // Set up canvas for QR scanning
        const ctx = canvasEl.getContext('2d');
        canvasEl.width = videoEl.videoWidth || 640;
        canvasEl.height = videoEl.videoHeight || 480;
        
        // Start scanning
        function scanQR() {
          if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
            canvasEl.width = videoEl.videoWidth;
            canvasEl.height = videoEl.videoHeight;
            ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
            
            const imageData = ctx.getImageData(0, 0, canvasEl.width, canvasEl.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code && code.data !== scannedData) {
              scannedData = code.data;
              statusEl.innerHTML = '‚úì QR Code found! Verifying...';
              statusEl.className = 'status success';
              
              // Verify against database
              saveQRToDatabase(code.data).then(result => {
                if (result && result.valid) {
                  resultEl.innerHTML = `<strong>‚úì Access Granted!</strong><br>Welcome to the buffet`;
                  resultEl.className = 'result success';
                  statusEl.innerHTML = '‚úì Valid QR code! Redirecting...';
                  statusEl.className = 'status success';
                  resultEl.style.display = 'block';
                  // Redirect to success page after 1 second
                  setTimeout(() => {
                    window.location.href = result.redirect_url;
                  }, 1000);
                } else {
                  resultEl.innerHTML = `<strong>‚úó Invalid QR Code</strong><br>Code not recognized`;
                  resultEl.className = 'result error';
                  statusEl.innerHTML = '‚ùå QR code not recognized';
                  statusEl.className = 'status error';
                  resultEl.style.display = 'block';
                  scannedData = null; // Reset to scan again
                }
              });
            }
          }
          requestAnimationFrame(scanQR);
        }
        
        scanQR();
      } catch (err) {
        statusEl.innerHTML = '‚ùå Camera access denied or unavailable';
        statusEl.className = 'status error';
      }
    }

    startCamera();
  </script>
</body>
</html>
